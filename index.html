<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gas Station & C-Store Opening Alerts Feed - LIVE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: start;
            gap: 20px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .header-left {
            flex: 1;
        }

        .header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .manage-feeds-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .manage-feeds-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .search-queries, .rss-feeds-section {
            background: #f3f4f6;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .search-queries h3 {
            color: #333;
            margin-bottom: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rss-feeds-section h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-icon {
            font-size: 0.8em;
            transition: transform 0.3s;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        .query-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 10px;
        }

        .query-item {
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.9em;
            color: #4b5563;
            border: 1px solid #e5e7eb;
        }

        .rss-dropdown {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 0.95em;
            color: #333;
            background: white;
            cursor: pointer;
            outline: none;
            transition: all 0.3s;
        }

        .rss-dropdown:hover {
            border-color: #764ba2;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .rss-dropdown:focus {
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .favorites-section {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            color: white;
        }

        .favorites-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .favorites-title {
            font-size: 1.5em;
            font-weight: 600;
        }

        .toggle-view-btn {
            padding: 10px 20px;
            background: white;
            color: #f59e0b;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .toggle-view-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .favorites-empty {
            text-align: center;
            padding: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            font-size: 1.1em;
        }

        .feed-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
            gap: 15px;
        }

        .feed-title {
            font-size: 1.5em;
            color: #333;
        }

        .filter-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
            max-width: 400px;
        }

        .filter-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9em;
            outline: none;
            transition: border-color 0.3s;
        }

        .filter-input:focus {
            border-color: #667eea;
        }

        .clear-filter-btn {
            padding: 10px 15px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .clear-filter-btn:hover {
            background: #dc2626;
        }

        .filter-stats {
            font-size: 0.9em;
            color: #6b7280;
            margin-bottom: 15px;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .live-indicator.loading {
            background: #fbbf24;
            color: #78350f;
        }

        .live-indicator.live {
            background: #10b981;
            color: white;
        }

        .live-indicator.waiting {
            background: #94a3b8;
            color: white;
        }

        .pulse {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .alert-item {
            background: #f9fafb;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            animation: slideIn 0.5s ease-out;
            transition: opacity 0.3s;
            position: relative;
        }

        .alert-item.filtered-out {
            display: none;
        }

        .alert-item.favorited {
            border-left-color: #fbbf24;
            background: linear-gradient(to right, #fffbeb 0%, #f9fafb 100%);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
            gap: 10px;
        }

        .alert-title-container {
            display: flex;
            align-items: start;
            gap: 10px;
            flex: 1;
        }

        .favorite-btn {
            background: none;
            border: none;
            font-size: 1.3em;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .favorite-btn:hover {
            transform: scale(1.2);
        }

        .favorite-btn.active {
            filter: drop-shadow(0 0 3px #fbbf24);
        }

        .alert-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #1f2937;
            flex: 1;
        }

        .alert-time {
            font-size: 0.85em;
            color: #6b7280;
            white-space: nowrap;
            margin-left: 15px;
        }

        .alert-source {
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .alert-snippet {
            color: #4b5563;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .no-alerts {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        /* Category Filter Tabs */
        .category-tabs {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-x: auto;
        }

        .tabs-container {
            display: flex;
            gap: 10px;
            min-width: min-content;
        }

        .category-tab {
            padding: 12px 24px;
            background: #f3f4f6;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-tab:hover {
            background: #e5e7eb;
            color: #4b5563;
        }

        .category-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .category-tab .count {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
        }

        .category-tab.active .count {
            background: rgba(255,255,255,0.3);
        }

        /* Enhanced Filters */
        .enhanced-filters {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 0.9em;
            font-weight: 600;
            color: #4b5563;
        }

        .filter-select {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9em;
            outline: none;
            transition: border-color 0.3s;
            background: white;
            cursor: pointer;
        }

        .filter-select:focus {
            border-color: #667eea;
        }

        .date-range-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .date-input {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9em;
            outline: none;
            transition: border-color 0.3s;
        }

        .date-input:focus {
            border-color: #667eea;
        }

        .clear-filters-btn {
            padding: 10px 20px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
            align-self: end;
        }

        .clear-filters-btn:hover {
            background: #dc2626;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: white;
            border-radius: 15px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.8em;
            color: #9ca3af;
            cursor: pointer;
            line-height: 1;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: #ef4444;
        }

        .modal-body {
            padding: 30px;
            overflow-y: auto;
            max-height: calc(90vh - 150px);
        }

        .modal-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e5e7eb;
            overflow-x: auto;
        }

        .modal-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .modal-tab:hover {
            color: #667eea;
        }

        .modal-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .feed-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .feed-item {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
        }

        .feed-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .feed-info {
            flex: 1;
        }

        .feed-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .feed-url {
            font-size: 0.85em;
            color: #6b7280;
            word-break: break-all;
        }

        .feed-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: #cbd5e1;
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #10b981;
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        .delete-feed-btn {
            padding: 8px 16px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: background 0.3s;
        }

        .delete-feed-btn:hover {
            background: #dc2626;
        }

        .add-feed-form, .add-category-form {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .form-title {
            color: white;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            color: white;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            font-size: 0.9em;
            outline: none;
            background: rgba(255,255,255,0.9);
            transition: all 0.3s;
        }

        .form-input:focus {
            background: white;
            border-color: white;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .submit-btn {
            padding: 10px 24px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,255,255,0.3);
        }

        .cancel-btn {
            padding: 10px 24px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .cancel-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .empty-category {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .tabs-container {
                flex-wrap: wrap;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .modal {
                max-width: 100%;
                margin: 10px;
            }

            .feed-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .feed-controls {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div class="header-left">
                    <h1>‚õΩ Gas Station & C-Store Opening Alerts</h1>
                    <p class="subtitle">Real-time monitoring of new gas stations, convenience stores, and fuel centers</p>
                </div>
                <div class="header-right">
                    <button class="manage-feeds-btn" onclick="openManageFeeds()">
                        ‚öôÔ∏è Manage Feeds
                    </button>
                </div>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalAlerts">29</div>
                    <div class="stat-label">Active RSS Feeds</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayCount">0</div>
                    <div class="stat-label">Alerts Loaded</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="backendStatus">üü°</div>
                    <div class="stat-label">Server Status</div>
                </div>
            </div>
        </header>

        <!-- Category Filter Tabs -->
        <div class="category-tabs">
            <div class="tabs-container" id="categoryTabs">
                <div class="category-tab active" data-category="all" onclick="filterByCategory('all')">
                    All <span class="count" id="count-all">0</span>
                </div>
            </div>
        </div>

        <!-- Enhanced Filters -->
        <div class="enhanced-filters">
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">üìÖ Date Range</label>
                    <select class="filter-select" id="dateRangeFilter" onchange="applyFilters()">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div class="filter-group" id="customDateGroup" style="display: none;">
                    <label class="filter-label">Custom Date Range</label>
                    <div class="date-range-inputs">
                        <input type="date" class="date-input" id="startDate" onchange="applyFilters()">
                        <input type="date" class="date-input" id="endDate" onchange="applyFilters()">
                    </div>
                </div>
                <div class="filter-group">
                    <label class="filter-label">üì∞ Source</label>
                    <select class="filter-select" id="sourceFilter" onchange="applyFilters()">
                        <option value="all">All Sources</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">üîç Keyword</label>
                    <input
                        type="text"
                        class="filter-input"
                        id="keywordFilter"
                        placeholder="Filter by keyword..."
                        onkeyup="applyFilters()"
                    >
                </div>
                <button class="clear-filters-btn" onclick="clearAllFilters()">
                    Clear All Filters
                </button>
            </div>
        </div>

        <div class="search-queries">
            <h3 onclick="toggleSection('queries')">
                <span class="toggle-icon" id="queries-icon">‚ñº</span>
                üîç Gas Station Search Queries (10)
            </h3>
            <div class="collapsible-content" id="queries-content">
                <div class="query-grid">
                    <div class="query-item">"new gas station" "opening soon"</div>
                    <div class="query-item">"convenience store" "fuel pumps" "coming soon"</div>
                    <div class="query-item">"travel center" "new construction"</div>
                    <div class="query-item">"fuel station" "permit approved"</div>
                    <div class="query-item">"service station" "new development"</div>
                    <div class="query-item">"filling station" "coming soon"</div>
                    <div class="query-item">"c-store" "fuel" "new location"</div>
                    <div class="query-item">"truck stop" "new construction"</div>
                    <div class="query-item">"gas bar" "opening"</div>
                    <div class="query-item">"convenience mart" "gas pumps" "new"</div>
                </div>
            </div>
        </div>

        <div class="rss-feeds-section">
            <h3>üì° Active RSS Feeds (34) - Gas Stations Only</h3>
            <select class="rss-dropdown" id="rssDropdown">
                <option value="">-- Select an alert to view its search query --</option>
            </select>
        </div>

        <div class="favorites-section" id="favoritesSection" style="display: none;">
            <div class="favorites-header">
                <div class="favorites-title">‚≠ê Favorites</div>
                <button class="toggle-view-btn" id="toggleViewBtn" onclick="toggleView()">
                    Show All Alerts
                </button>
            </div>
            <div id="favoritesFeed">
                <div class="favorites-empty">
                    No favorites yet. Click the star on any alert to save it here!
                </div>
            </div>
        </div>

        <div class="feed-container">
            <div class="feed-header">
                <div class="feed-title">üì∞ Live Feed</div>
                <div class="filter-container">
                    <input
                        type="text"
                        class="filter-input"
                        id="filterInput"
                        placeholder="üîç Filter alerts by keyword..."
                        onkeyup="filterAlerts()"
                    >
                    <button class="clear-filter-btn" onclick="clearFilter()">‚úï</button>
                </div>
                <div class="live-indicator loading" id="liveIndicator">
                    <div class="pulse"></div>
                    <span id="statusText">CONNECTING</span>
                </div>
            </div>

            <div class="filter-stats" id="filterStats" style="display: none;"></div>

            <div id="alertsFeed">
                <div class="no-alerts">
                    <p>Connecting to backend server...</p>
                    <p style="font-size: 0.9em; margin-top: 10px;">Fetching RSS feeds from Google Alerts...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Feed Management Modal -->
    <div class="modal-overlay" id="manageFeedsModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">‚öôÔ∏è Manage RSS Feeds</h2>
                <button class="modal-close" onclick="closeManageFeeds()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-tabs" id="modalTabs">
                    <!-- Tabs will be dynamically generated -->
                </div>
                <div id="tabContents">
                    <!-- Tab contents will be dynamically generated -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Backend configuration
        const BACKEND_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3000'
            : 'https://gas-station-alerts-backend-2.onrender.com';
        const API_URL = `${BACKEND_URL}/api/feeds`;
        const CATEGORIES_API = `${BACKEND_URL}/api/categories`;

        // RSS Feed URLs - Gas Station Alerts Only
        const RSS_FEEDS = [
            'https://www.google.com/alerts/feeds/09182428279069180430/2356736684601183531',
            'https://www.google.com/alerts/feeds/09182428279069180430/10272491932958314872',
            'https://www.google.com/alerts/feeds/09182428279069180430/18098273169971572213',
            'https://www.google.com/alerts/feeds/09182428279069180430/7464813959798405035',
            'https://www.google.com/alerts/feeds/09182428279069180430/17182240907846120717',
            'https://www.google.com/alerts/feeds/09182428279069180430/1226120987289009438',
            'https://www.google.com/alerts/feeds/09182428279069180430/3328131774048131868',
            'https://www.google.com/alerts/feeds/09182428279069180430/2641101500755475746',
            'https://www.google.com/alerts/feeds/09182428279069180430/2665165367342573063',
            'https://www.google.com/alerts/feeds/09182428279069180430/1856006892992916883',
            'https://www.google.com/alerts/feeds/09182428279069180430/11760473391334443585',
            'https://www.google.com/alerts/feeds/09182428279069180430/16754394224087368820',
            'https://www.google.com/alerts/feeds/09182428279069180430/805090456831878584',
            'https://www.google.com/alerts/feeds/09182428279069180430/2356736684601182860',
            'https://www.google.com/alerts/feeds/09182428279069180430/11561908779301281246',
            'https://www.google.com/alerts/feeds/09182428279069180430/2862118317250464279',
            'https://www.google.com/alerts/feeds/09182428279069180430/7125003852991128726',
            'https://www.google.com/alerts/feeds/09182428279069180430/8854767764924737815',
            'https://www.google.com/alerts/feeds/09182428279069180430/2214701372282077850',
            'https://www.google.com/alerts/feeds/09182428279069180430/15967401914306998170',
            'https://www.google.com/alerts/feeds/09182428279069180430/18098273169971569420',
            'https://www.google.com/alerts/feeds/09182428279069180430/6030688961984603201',
            'https://www.google.com/alerts/feeds/09182428279069180430/13923193800938194260',
            'https://www.google.com/alerts/feeds/09182428279069180430/10812523901845474331',
            'https://www.google.com/alerts/feeds/09182428279069180430/17386860109803368591',
            'https://www.google.com/alerts/feeds/09182428279069180430/14009841047842724740',
            'https://www.google.com/alerts/feeds/09182428279069180430/3546512814188894202',
            'https://www.google.com/alerts/feeds/09182428279069180430/805090456831878167',
            'https://www.google.com/alerts/feeds/09182428279069180430/1226120987289009546'
        ];

        let alertCount = 0;
        let lastFetchTime = null;
        let allAlerts = [];
        let favorites = new Set();
        let viewMode = 'all'; // 'all' or 'favorites'
        let currentCategory = 'all';
        let categories = [];
        let uniqueSources = new Set();
        let currentFilters = {
            category: 'all',
            dateRange: 'all',
            source: 'all',
            keyword: ''
        };

        // Alert names corresponding to RSS feeds
        const ALERT_NAMES = [
            '"c-store" "fuel" "new location"',
            '"c-store" "fuel" construction (excluding major chains)',
            '"convenience mart" "fuel" opening (excluding major chains)',
            '"convenience mart" "gas pumps" "new"',
            '"convenience store" "fuel pumps" "coming soon"',
            '"convenience store" "fuel pumps" permit (excluding major chains)',
            '"filling station" "coming soon"',
            '"filling station" opening (excluding major chains)',
            '"fuel center" construction (excluding major chains)',
            '"fuel mart" new (excluding major chains)',
            '"fuel station" "permit approved"',
            '"fuel station" permit (excluding major chains)',
            '"fuel stop" new (excluding major chains)',
            '"gas bar" "opening"',
            '"gas bar" construction (excluding major chains)',
            '"gas station construction" (excluding major chains)',
            '"gas station" "breaking ground" (excluding major chains)',
            '"gas station" "coming soon" (excluding major chains)',
            '"gas station" "grand opening" (excluding major chains)',
            '"gas station" "land use" (excluding major chains)',
            '"gas station" "now open" (excluding major chains)',
            '"gas station" "ribbon cutting" (excluding major chains)',
            '"gas station" "site plan" (excluding major chains)',
            '"gas station" approved (excluding major chains)',
            '"gas station" proposal (excluding major chains)',
            '"gas station" zoning (excluding major chains)',
            '"independent gas station" new (excluding major chains)',
            '"new gas station" "opening soon"',
            '"new gas station" opening (excluding major chains)',
            '"travel center" "new construction"',
            '"service station" "new development"',
            '"truck stop" "new construction"',
            '"petrol station" "opening"',
            '"refueling station" "new"'
        ];

        // Load favorites from localStorage
        function loadFavorites() {
            const saved = localStorage.getItem('gasStationFavorites');
            if (saved) {
                favorites = new Set(JSON.parse(saved));
            }
        }

        // Save favorites to localStorage
        function saveFavorites() {
            localStorage.setItem('gasStationFavorites', JSON.stringify([...favorites]));
        }

        // Toggle favorite status
        function toggleFavorite(alertId) {
            if (favorites.has(alertId)) {
                favorites.delete(alertId);
            } else {
                favorites.add(alertId);
            }
            saveFavorites();
            updateFavoriteButtons();
            updateFavoritesSection();
        }

        // Update favorite button states
        function updateFavoriteButtons() {
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                const alertId = btn.getAttribute('data-alert-id');
                const isFavorited = favorites.has(alertId);
                btn.textContent = isFavorited ? '‚≠ê' : '‚òÜ';
                btn.classList.toggle('active', isFavorited);
                btn.closest('.alert-item').classList.toggle('favorited', isFavorited);
            });
        }

        // Update favorites section
        function updateFavoritesSection() {
            const favSection = document.getElementById('favoritesSection');
            const favFeed = document.getElementById('favoritesFeed');

            if (favorites.size === 0) {
                favSection.style.display = 'none';
                favFeed.innerHTML = '<div class="favorites-empty">No favorites yet. Click the star on any alert to save it here!</div>';
                return;
            }

            favSection.style.display = 'block';
            favFeed.innerHTML = '';

            // Get favorited alerts and sort by most recent
            const favoritedAlerts = allAlerts.filter(alert => favorites.has(getAlertId(alert)));

            if (favoritedAlerts.length === 0) {
                favFeed.innerHTML = '<div class="favorites-empty">No favorites yet. Click the star on any alert to save it here!</div>';
                return;
            }

            favoritedAlerts.forEach(alert => {
                const alertDiv = createAlertElement(alert);
                favFeed.appendChild(alertDiv);
            });
        }

        // Toggle between All Alerts and Favorites Only view
        function toggleView() {
            viewMode = viewMode === 'all' ? 'favorites' : 'all';
            const btn = document.getElementById('toggleViewBtn');
            const mainFeed = document.getElementById('alertsFeed');

            if (viewMode === 'favorites') {
                btn.textContent = 'Show All Alerts';
                // Hide non-favorited alerts
                document.querySelectorAll('.alert-item').forEach(item => {
                    const btn = item.querySelector('.favorite-btn');
                    const alertId = btn.getAttribute('data-alert-id');
                    if (!favorites.has(alertId)) {
                        item.style.display = 'none';
                    }
                });
            } else {
                btn.textContent = 'Show Favorites Only';
                // Show all alerts
                document.querySelectorAll('.alert-item').forEach(item => {
                    item.style.display = '';
                });
                // Reapply filter if active
                filterAlerts();
            }
        }

        // Generate unique ID for alert
        function getAlertId(alert) {
            return alert.link || alert.guid || alert.title + alert.pubDate;
        }

        // Create alert element
        function createAlertElement(alert) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert-item';
            const alertLink = alert.link || alert.guid || '#';
            const alertTitle = alert.title || 'Untitled Alert';
            const alertId = getAlertId(alert);
            const isFavorited = favorites.has(alertId);

            if (isFavorited) {
                alertDiv.classList.add('favorited');
            }

            alertDiv.innerHTML = `
                <div class="alert-header">
                    <div class="alert-title-container">
                        <button class="favorite-btn ${isFavorited ? 'active' : ''}"
                                data-alert-id="${alertId}"
                                onclick="toggleFavorite('${alertId}')"
                                title="Add to favorites">
                            ${isFavorited ? '‚≠ê' : '‚òÜ'}
                        </button>
                        <div class="alert-title">
                            <a href="${alertLink}" target="_blank" rel="noopener noreferrer" style="color: #1f2937; text-decoration: none; display: block; transition: color 0.3s;" onmouseover="this.style.color='#667eea'" onmouseout="this.style.color='#1f2937'">
                                ${alertTitle}
                            </a>
                        </div>
                    </div>
                    <div class="alert-time">${formatTime(alert.pubDate || alert.isoDate || new Date())}</div>
                </div>
                <div class="alert-source">üì∞ ${alert.source || 'Google Alerts'}</div>
                <div class="alert-snippet">${alert.contentSnippet || alert.content || 'No description available'}</div>
            `;

            return alertDiv;
        }

        // Populate RSS dropdown
        function populateRSSDropdown() {
            const dropdown = document.getElementById('rssDropdown');
            ALERT_NAMES.slice(0, 29).forEach((name, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = name;
                dropdown.appendChild(option);
            });
        }

        // Toggle collapsible sections
        function toggleSection(sectionId) {
            const content = document.getElementById(`${sectionId}-content`);
            const icon = document.getElementById(`${sectionId}-icon`);

            content.classList.toggle('collapsed');
            icon.classList.toggle('collapsed');
        }

        // Filter alerts
        function filterAlerts() {
            const filterValue = document.getElementById('filterInput').value.toLowerCase();
            const alerts = document.querySelectorAll('#alertsFeed .alert-item');
            const filterStats = document.getElementById('filterStats');

            let visibleCount = 0;

            alerts.forEach(alert => {
                const text = alert.textContent.toLowerCase();
                const shouldShow = text.includes(filterValue);

                // Only apply filter if we're in "all" mode or if the alert matches filter
                if (viewMode === 'favorites') {
                    const btn = alert.querySelector('.favorite-btn');
                    const alertId = btn.getAttribute('data-alert-id');
                    const isFavorited = favorites.has(alertId);

                    if (isFavorited && shouldShow) {
                        alert.classList.remove('filtered-out');
                        alert.style.display = '';
                        visibleCount++;
                    } else {
                        alert.classList.add('filtered-out');
                        if (!isFavorited) {
                            alert.style.display = 'none';
                        }
                    }
                } else {
                    if (shouldShow) {
                        alert.classList.remove('filtered-out');
                        visibleCount++;
                    } else {
                        alert.classList.add('filtered-out');
                    }
                }
            });

            if (filterValue) {
                filterStats.style.display = 'block';
                filterStats.textContent = `Showing ${visibleCount} of ${alerts.length} alerts matching "${filterValue}"`;
            } else {
                filterStats.style.display = 'none';
            }
        }

        // Clear filter
        function clearFilter() {
            document.getElementById('filterInput').value = '';
            filterAlerts();
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        }

        function updateLiveIndicator(status, text) {
            const indicator = document.getElementById('liveIndicator');
            const statusText = document.getElementById('statusText');

            indicator.className = `live-indicator ${status}`;
            statusText.textContent = text;
        }

        function updateBackendStatus(status) {
            const statusEl = document.getElementById('backendStatus');
            if (status === 'online') {
                statusEl.textContent = 'üü¢';
            } else if (status === 'loading') {
                statusEl.textContent = 'üü°';
            } else {
                statusEl.textContent = 'üî¥';
            }
        }

        function addAlertToFeed(alert) {
            const feed = document.getElementById('alertsFeed');

            // Remove "no alerts" message
            const noAlerts = feed.querySelector('.no-alerts');
            if (noAlerts) {
                noAlerts.remove();
            }

            const alertDiv = createAlertElement(alert);

            // Append to feed (backend already sorts newest first)
            feed.appendChild(alertDiv);
            allAlerts.push(alert);
            alertCount++;
            document.getElementById('todayCount').textContent = alertCount;
        }

        async function fetchRSSFeeds() {
            try {
                console.log('Fetching RSS feeds from:', API_URL);
                updateLiveIndicator('loading', 'LOADING');
                updateBackendStatus('loading');

                const response = await fetch(API_URL);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Received data:', data);

                if (data.success && data.items && data.items.length > 0) {
                    updateLiveIndicator('live', 'LIVE');
                    updateBackendStatus('online');

                    data.items.forEach(item => {
                        addAlertToFeed(item);
                    });

                    lastFetchTime = new Date();
                    updateFavoritesSection();
                } else {
                    updateLiveIndicator('waiting', 'WAITING');
                    updateBackendStatus('online');
                    console.log('No items in response');
                }
            } catch (error) {
                console.error('Error fetching RSS feeds:', error);
                updateLiveIndicator('waiting', 'ERROR');
                updateBackendStatus('offline');

                const feed = document.getElementById('alertsFeed');
                if (feed.children.length === 0) {
                    feed.innerHTML = `
                        <div class="no-alerts">
                            <p>Could not connect to backend server</p>
                            <p style="font-size: 0.9em; margin-top: 10px;">Error: ${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        // ========== PHASE 1: CATEGORY MANAGEMENT ==========

        async function loadCategories() {
            try {
                const response = await fetch(CATEGORIES_API);
                if (!response.ok) throw new Error('Failed to load categories');

                const data = await response.json();
                categories = data.categories || [];
                renderCategoryTabs();
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function renderCategoryTabs() {
            const tabsContainer = document.getElementById('categoryTabs');
            tabsContainer.innerHTML = '';

            // All tab
            const allTab = document.createElement('div');
            allTab.className = 'category-tab' + (currentCategory === 'all' ? ' active' : '');
            allTab.setAttribute('data-category', 'all');
            allTab.onclick = () => filterByCategory('all');
            allTab.innerHTML = `All <span class="count" id="count-all">0</span>`;
            tabsContainer.appendChild(allTab);

            // Category tabs
            categories.forEach(cat => {
                const tab = document.createElement('div');
                tab.className = 'category-tab' + (currentCategory === cat.id ? ' active' : '');
                tab.setAttribute('data-category', cat.id);
                tab.onclick = () => filterByCategory(cat.id);
                tab.innerHTML = `${cat.name} <span class="count" id="count-${cat.id}">0</span>`;
                tabsContainer.appendChild(tab);
            });

            updateCategoryCounts();
        }

        function updateCategoryCounts() {
            // Count all alerts
            document.getElementById('count-all').textContent = allAlerts.length;

            // Count per category
            categories.forEach(cat => {
                const count = allAlerts.filter(alert => alert.category === cat.id).length;
                const countEl = document.getElementById(`count-${cat.id}`);
                if (countEl) countEl.textContent = count;
            });
        }

        function filterByCategory(categoryId) {
            currentCategory = categoryId;
            currentFilters.category = categoryId;

            // Update active tab
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.toggle('active', tab.getAttribute('data-category') === categoryId);
            });

            applyFilters();
        }

        // ========== PHASE 1: ENHANCED FILTERING ==========

        function applyFilters() {
            const dateRange = document.getElementById('dateRangeFilter').value;
            const source = document.getElementById('sourceFilter').value;
            const keyword = document.getElementById('keywordFilter').value.toLowerCase();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            currentFilters = {
                category: currentCategory,
                dateRange: dateRange,
                source: source,
                keyword: keyword
            };

            // Show/hide custom date inputs
            const customDateGroup = document.getElementById('customDateGroup');
            customDateGroup.style.display = dateRange === 'custom' ? 'block' : 'none';

            const alerts = document.querySelectorAll('#alertsFeed .alert-item');
            let visibleCount = 0;

            alerts.forEach(alert => {
                const alertData = allAlerts.find(a => getAlertId(a) === alert.querySelector('.favorite-btn').getAttribute('data-alert-id'));
                if (!alertData) return;

                let show = true;

                // Category filter
                if (currentCategory !== 'all' && alertData.category !== currentCategory) {
                    show = false;
                }

                // Date filter
                if (show && dateRange !== 'all') {
                    const alertDate = new Date(alertData.pubDate || alertData.isoDate);
                    const now = new Date();

                    if (dateRange === 'today') {
                        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        show = alertDate >= today;
                    } else if (dateRange === 'week') {
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        show = alertDate >= weekAgo;
                    } else if (dateRange === 'month') {
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        show = alertDate >= monthAgo;
                    } else if (dateRange === 'custom' && startDate && endDate) {
                        const start = new Date(startDate);
                        const end = new Date(endDate);
                        end.setHours(23, 59, 59, 999);
                        show = alertDate >= start && alertDate <= end;
                    }
                }

                // Source filter
                if (show && source !== 'all') {
                    show = (alertData.source || 'Google Alerts') === source;
                }

                // Keyword filter
                if (show && keyword) {
                    const text = alert.textContent.toLowerCase();
                    show = text.includes(keyword);
                }

                // View mode filter (favorites)
                if (show && viewMode === 'favorites') {
                    const alertId = alert.querySelector('.favorite-btn').getAttribute('data-alert-id');
                    show = favorites.has(alertId);
                }

                if (show) {
                    alert.classList.remove('filtered-out');
                    alert.style.display = '';
                    visibleCount++;
                } else {
                    alert.classList.add('filtered-out');
                    alert.style.display = 'none';
                }
            });

            // Update filter stats
            updateFilterStats(visibleCount, alerts.length);
        }

        function updateFilterStats(visible, total) {
            const filterStats = document.getElementById('filterStats');
            const activeFilters = [];

            if (currentFilters.category !== 'all') {
                const cat = categories.find(c => c.id === currentFilters.category);
                activeFilters.push(`Category: ${cat ? cat.name : currentFilters.category}`);
            }
            if (currentFilters.dateRange !== 'all') {
                activeFilters.push(`Date: ${currentFilters.dateRange}`);
            }
            if (currentFilters.source !== 'all') {
                activeFilters.push(`Source: ${currentFilters.source}`);
            }
            if (currentFilters.keyword) {
                activeFilters.push(`Keyword: "${currentFilters.keyword}"`);
            }

            if (activeFilters.length > 0) {
                filterStats.style.display = 'block';
                filterStats.textContent = `Showing ${visible} of ${total} alerts (${activeFilters.join(', ')})`;
            } else {
                filterStats.style.display = 'none';
            }
        }

        function clearAllFilters() {
            document.getElementById('dateRangeFilter').value = 'all';
            document.getElementById('sourceFilter').value = 'all';
            document.getElementById('keywordFilter').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('customDateGroup').style.display = 'none';

            currentFilters = {
                category: currentCategory,
                dateRange: 'all',
                source: 'all',
                keyword: ''
            };

            applyFilters();
        }

        function populateSourceFilter() {
            const sourceFilter = document.getElementById('sourceFilter');
            sourceFilter.innerHTML = '<option value="all">All Sources</option>';

            const sources = Array.from(uniqueSources).sort();
            sources.forEach(source => {
                const option = document.createElement('option');
                option.value = source;
                option.textContent = source;
                sourceFilter.appendChild(option);
            });
        }

        // ========== PHASE 1: FEED MANAGEMENT MODAL ==========

        function openManageFeeds() {
            const modal = document.getElementById('manageFeedsModal');
            modal.classList.add('active');
            renderModalTabs();
        }

        function closeManageFeeds() {
            const modal = document.getElementById('manageFeedsModal');
            modal.classList.remove('active');
        }

        async function renderModalTabs() {
            const tabsContainer = document.getElementById('modalTabs');
            const contentsContainer = document.getElementById('tabContents');

            tabsContainer.innerHTML = '';
            contentsContainer.innerHTML = '';

            // Add "Create Category" tab
            const createCatTab = document.createElement('button');
            createCatTab.className = 'modal-tab';
            createCatTab.textContent = '‚ûï Create Category';
            createCatTab.onclick = () => switchModalTab('create-category');
            tabsContainer.appendChild(createCatTab);

            // Create category content
            const createCatContent = document.createElement('div');
            createCatContent.className = 'tab-content';
            createCatContent.id = 'tab-create-category';
            createCatContent.innerHTML = `
                <div class="add-category-form">
                    <div class="form-title">Create New Category</div>
                    <div class="form-group">
                        <label class="form-label">Category ID (lowercase, no spaces)</label>
                        <input type="text" class="form-input" id="newCategoryId" placeholder="e.g., gas-stations">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category Name</label>
                        <input type="text" class="form-input" id="newCategoryName" placeholder="e.g., Gas Stations">
                    </div>
                    <div class="form-actions">
                        <button class="cancel-btn" onclick="closeManageFeeds()">Cancel</button>
                        <button class="submit-btn" onclick="createCategory()">Create Category</button>
                    </div>
                </div>
            `;
            contentsContainer.appendChild(createCatContent);

            // Add category tabs
            for (const cat of categories) {
                const tab = document.createElement('button');
                tab.className = 'modal-tab';
                tab.textContent = cat.name;
                tab.onclick = () => switchModalTab(cat.id);
                tabsContainer.appendChild(tab);

                const content = document.createElement('div');
                content.className = 'tab-content';
                content.id = `tab-${cat.id}`;
                content.innerHTML = await renderCategoryFeeds(cat);
                contentsContainer.appendChild(content);
            }

            // Activate first tab
            if (tabsContainer.children.length > 0) {
                tabsContainer.children[0].classList.add('active');
                contentsContainer.children[0].classList.add('active');
            }
        }

        function switchModalTab(tabId) {
            document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        async function renderCategoryFeeds(category) {
            const feeds = category.feeds || [];

            let html = '<div class="feed-list">';

            if (feeds.length === 0) {
                html += '<div class="empty-category">No feeds in this category yet. Add one below!</div>';
            } else {
                feeds.forEach(feed => {
                    html += `
                        <div class="feed-item">
                            <div class="feed-info">
                                <div class="feed-name">${feed.name || 'Unnamed Feed'}</div>
                                <div class="feed-url">${feed.url}</div>
                            </div>
                            <div class="feed-controls">
                                <div class="toggle-switch ${feed.enabled ? 'active' : ''}"
                                     onclick="toggleFeed('${category.id}', '${feed.url}', ${!feed.enabled})">
                                    <div class="toggle-slider"></div>
                                </div>
                                <button class="delete-feed-btn" onclick="deleteFeed('${category.id}', '${feed.url}')">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                });
            }

            html += `</div>
                <div class="add-feed-form">
                    <div class="form-title">‚ûï Add New Feed</div>
                    <div class="form-group">
                        <label class="form-label">Feed URL</label>
                        <input type="text" class="form-input" id="feedUrl-${category.id}"
                               placeholder="https://www.google.com/alerts/feeds/...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Feed Name</label>
                        <input type="text" class="form-input" id="feedName-${category.id}"
                               placeholder="e.g., New Gas Stations Opening">
                    </div>
                    <div class="form-actions">
                        <button class="submit-btn" onclick="addFeed('${category.id}')">Add Feed</button>
                    </div>
                </div>
            `;

            return html;
        }

        async function createCategory() {
            const categoryId = document.getElementById('newCategoryId').value.trim();
            const categoryName = document.getElementById('newCategoryName').value.trim();

            if (!categoryId || !categoryName) {
                alert('Please fill in both category ID and name');
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/api/categories`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categoryId, categoryName })
                });

                if (!response.ok) throw new Error('Failed to create category');

                const data = await response.json();
                alert('Category created successfully!');

                // Reload categories and update UI
                await loadCategories();
                renderModalTabs();
            } catch (error) {
                console.error('Error creating category:', error);
                alert('Failed to create category: ' + error.message);
            }
        }

        async function addFeed(categoryId) {
            const feedUrl = document.getElementById(`feedUrl-${categoryId}`).value.trim();
            const feedName = document.getElementById(`feedName-${categoryId}`).value.trim();

            if (!feedUrl || !feedName) {
                alert('Please fill in both feed URL and name');
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/api/feeds`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categoryId, feedUrl, feedName })
                });

                if (!response.ok) throw new Error('Failed to add feed');

                const data = await response.json();
                alert('Feed added successfully!');

                // Reload categories and update UI
                await loadCategories();
                renderModalTabs();
            } catch (error) {
                console.error('Error adding feed:', error);
                alert('Failed to add feed: ' + error.message);
            }
        }

        async function deleteFeed(categoryId, feedUrl) {
            if (!confirm('Are you sure you want to delete this feed?')) return;

            try {
                const response = await fetch(`${BACKEND_URL}/api/feeds`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categoryId, feedUrl })
                });

                if (!response.ok) throw new Error('Failed to delete feed');

                const data = await response.json();
                alert('Feed deleted successfully!');

                // Reload categories and update UI
                await loadCategories();
                renderModalTabs();
            } catch (error) {
                console.error('Error deleting feed:', error);
                alert('Failed to delete feed: ' + error.message);
            }
        }

        async function toggleFeed(categoryId, feedUrl, enabled) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/feeds/toggle`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categoryId, feedUrl, enabled })
                });

                if (!response.ok) throw new Error('Failed to toggle feed');

                const data = await response.json();

                // Reload categories and update UI
                await loadCategories();
                renderModalTabs();
            } catch (error) {
                console.error('Error toggling feed:', error);
                alert('Failed to toggle feed: ' + error.message);
            }
        }

        // ========== MODIFIED FETCH FUNCTION ==========

        async function fetchRSSFeeds() {
            try {
                console.log('Fetching RSS feeds from:', API_URL);
                updateLiveIndicator('loading', 'LOADING');
                updateBackendStatus('loading');

                // Build query with category filter if needed
                let url = API_URL;
                if (currentCategory !== 'all') {
                    url += `?category=${currentCategory}`;
                }

                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Received data:', data);

                if (data.success && data.items && data.items.length > 0) {
                    updateLiveIndicator('live', 'LIVE');
                    updateBackendStatus('online');

                    // Clear existing alerts if switching categories
                    const feed = document.getElementById('alertsFeed');
                    feed.innerHTML = '';
                    allAlerts = [];
                    alertCount = 0;

                    data.items.forEach(item => {
                        // Extract unique sources
                        uniqueSources.add(item.source || 'Google Alerts');
                        addAlertToFeed(item);
                    });

                    lastFetchTime = new Date();
                    updateFavoritesSection();
                    updateCategoryCounts();
                    populateSourceFilter();
                    applyFilters();
                } else {
                    updateLiveIndicator('waiting', 'WAITING');
                    updateBackendStatus('online');
                    console.log('No items in response');
                }
            } catch (error) {
                console.error('Error fetching RSS feeds:', error);
                updateLiveIndicator('waiting', 'ERROR');
                updateBackendStatus('offline');

                const feed = document.getElementById('alertsFeed');
                if (feed.children.length === 0) {
                    feed.innerHTML = `
                        <div class="no-alerts">
                            <p>Could not connect to backend server</p>
                            <p style="font-size: 0.9em; margin-top: 10px;">Error: ${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        // Initialize
        window.addEventListener('load', async () => {
            loadFavorites();
            populateRSSDropdown();
            await loadCategories();
            await fetchRSSFeeds();
            updateFavoritesSection();

            // Refresh every 5 minutes
            setInterval(fetchRSSFeeds, 5 * 60 * 1000);
        });

        // Close modal on outside click
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('manageFeedsModal');
            if (e.target === modal) {
                closeManageFeeds();
            }
        });

        // Update date range filter to show/hide custom inputs
        document.getElementById('dateRangeFilter')?.addEventListener('change', (e) => {
            const customDateGroup = document.getElementById('customDateGroup');
            customDateGroup.style.display = e.target.value === 'custom' ? 'block' : 'none';
        });
    </script>
</body>
</html>
